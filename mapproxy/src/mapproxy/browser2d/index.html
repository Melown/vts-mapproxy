<!DOCTYPE html>
<html>
<head>
    <title>Map viewer</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
</head>
<body style="width:100%;height:100%">
    <div id="map" style="width:100%;height:100%;position:absolute;left:0px;top:0px"></div>

    <script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>

    <script>
      function loadMapConfig(callback) {
          var x = new XMLHttpRequest();
          x.overrideMimeType("application/json");
          x.open("GET", "mapConfig.json", true);
          x.onreadystatechange = function () {
              if ((x.readyState) == 4 && ((x.status == 200) || (x.status == 0)))
              {
                  callback(JSON.parse(x.responseText));
              }
          };
          x.send(null);
      }

      var map = new L.Map("map");

      loadMapConfig(function (mc) {
          var boundLayers = mc["boundLayers"];
          var credits = mc["credits"];
          var copyyear = "&copy; " + new Date().getFullYear() + " ";

          var maxLod = 0;
          for (var name in boundLayers) {
              if (!boundLayers.hasOwnProperty(name)) { continue; }

              var bl = boundLayers[name];
              var url = bl.url.replace(/{lod}/g, "{z}");

              var attribution = "";
              var prefix = "";
              for (var creditIndex in credits) {
                  var credit = credits[creditIndex];
                  attribution += prefix;
                  if (credit.copyrighted != false) {
                      attribution += copyyear;
                  }
                  attribution += credit.notice;
                  prefix = ", ";
              }

              if (bl.lodRange[1] > maxLod) {
                  maxLod = bl.lodRange[1];
              }

              var tl = new L.TileLayer(url, {
                  minZoom: bl.lodRange[0]
                  , maxZoom: bl.lodRange[1]
                  , attribution: attribution
              });
              map.addLayer(tl);

              if (bl.maskUrl) {
                  var murl = bl.maskUrl.replace(/{lod}/g, "{z}");

                  var mtl = new L.TileLayer(murl, {
                      minZoom: bl.lodRange[0]
                      , maxZoom: bl.lodRange[1]
                      , attribution: attribution
                      , opacity: 0.1
                  });
                  map.addLayer(mtl);
              }
          }

          // TODO: set from view mapConfig position
          map.setView(new L.LatLng(50, 15), maxLod);
      });

    </script>
</body>
</html>
