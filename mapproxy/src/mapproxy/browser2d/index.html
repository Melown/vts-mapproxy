<!DOCTYPE html>
<html>
<head>
    <title>Map viewer</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="leaflet.css" />
</head>
<body style="width:100%;height:100%">
    <div id="map" style="width:100%;height:100%;position:absolute;left:0px;top:0px"></div>

    <script src="leaflet.js"></script>

    <script>
      function loadMapConfig(callback) {
          var x = new XMLHttpRequest();
          x.overrideMimeType("application/json");
          x.open("GET", "mapConfig.json", true);
          x.onreadystatechange = function () {
              if ((x.readyState) == 4 && ((x.status == 200) || (x.status == 0)))
              {
                  callback(JSON.parse(x.responseText));
              }
          };
          x.send(null);
      }

      function quadKey(x, y, z) {
          var quadKey = [];
          for (i = z - 1; i >= 0; --i) {
              quadKey.push(((((y >> i) & 1) << 1) + ((x >> i) & 1)));
          }
          return quadKey.join('');
      }

      var BingLayer = L.TileLayer.extend({
          getTileUrl: function (tilePoint) {
              this._adjustTilePoint(tilePoint);
              return L.Util.template(this._url, {
                  quad: quadKey(tilePoint.x, tilePoint.y, this._getZoomForUrl())
              });
          }
      });

      var map = new L.Map("map");

      loadMapConfig(function (mc) {
          var boundLayers = mc["boundLayers"];
          var credits = mc["credits"];
          var copyyear = "&copy; " + new Date().getFullYear() + " ";

          var maxLod = 0;
          for (var name in boundLayers) {
              if (!boundLayers.hasOwnProperty(name)) { continue; }

              var bl = boundLayers[name];
              var url = bl.url.replace(/{lod}/g, "{z}")
                         .replace(/{loclod}/g, "{z}")
                         .replace(/{locx}/g, "{x}")
                         .replace(/{locy}/g, "{y}")
                         .replace(/{alt\(([^,)]+).*\)}/g, "$1");

              var attribution = "";
              var prefix = "";
              for (var creditIndex in credits) {
                  var credit = credits[creditIndex];
                  attribution += prefix;
                  if (credit.copyrighted != false) {
                      attribution += copyyear;
                  }
                  attribution += credit.notice;
                  prefix = ", ";
              }

              if (bl.lodRange[1] > maxLod) {
                  maxLod = bl.lodRange[1];
              }

              var layerGenerator = L.TileLayer;
              if (url.includes("{quad}")) {
                  layerGenerator = BingLayer;
              }

              var tl = new layerGenerator(url, {
                  minZoom: bl.lodRange[0]
                  , maxZoom: bl.lodRange[1]
                  , attribution: attribution
              });

              var layers = {};
              var overlays = {};
              layers[name] = tl;

              if (bl.maskUrl) {
                  var murl = bl.maskUrl.replace(/{lod}/g, "{z}");

                  var mtl = new L.TileLayer(murl, {
                      minZoom: bl.lodRange[0]
                      , maxZoom: bl.lodRange[1]
                      , attribution: attribution
                      , opacity: 0.25
                  });

                  overlays[name + "/mask"] = mtl;
              }

              L.control.layers(layers, overlays).addTo(map);
              map.addLayer(tl);
          }

          // TODO: set from view mapConfig position
          map.setView(new L.LatLng(50, 15), maxLod);
      });

    </script>
</body>
</html>
